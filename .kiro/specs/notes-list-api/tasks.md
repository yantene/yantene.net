# Implementation Plan

- [ ] 1. ページネーションパラメータの値オブジェクトと汎用ページネーション結果型を作成する
- [ ] 1.1 (P) ページネーションパラメータのバリデーションと保持を行う値オブジェクトを実装する
  - `page` と `perPage` の文字列入力を受け取り、正の整数へ変換して保持するイミュータブルな値オブジェクトを作成する
  - 未指定時のデフォルト値を適用する (`page`: 1, `perPage`: 20)
  - 不正値 (非数値、負数、0、小数) に対してバリデーションエラーをスローする
  - `perPage` が最大値 (100) を超えた場合にバリデーションエラーをスローする
  - `offset` 計算ロジック (`(page - 1) * perPage`) をプロパティとして提供する
  - バリデーションエラーはフィールド名と理由を含む型付きドメインエラーとして定義する
  - TDD で各バリデーションケース (デフォルト値適用、正常パラメータ、不正値) のテストを先行して作成する
  - _Requirements: 2.1, 2.2, 2.3, 2.4, 3.1, 3.2, 3.3_

- [ ] 1.2 (P) ページネーション結果を表す汎用型を定義する
  - データ配列とページネーションメタデータ (ページ番号、件数、総件数、総ページ数) を組み合わせた汎用的な型を定義する
  - ジェネリクスで任意のエンティティ型に対応し、Note ドメイン以外でも再利用可能にする
  - すべてのフィールドを readonly にしてイミュータビリティを保証する
  - _Requirements: 2.5, 4.1, 4.3_

- [ ] 2. クエリリポジトリにページネーション付き検索機能を追加する
- [ ] 2.1 既存のクエリリポジトリインターフェースにページネーション付き検索メソッドを追加する
  - ページネーションパラメータを受け取り、ページネーション結果を返す `findPaginated` メソッドをインターフェースに追加する
  - 既存の `findAll` と `findBySlug` メソッドに変更を加えない
  - タスク 1 で作成した値オブジェクトと型をインターフェースの契約に使用する
  - _Requirements: 6.3_

- [ ] 2.2 D1 リポジトリ実装にページネーション付き検索の具体的なクエリ処理を追加する
  - Drizzle ORM を使用して公開日降順ソート、オフセット、リミットによるページネーションクエリを実装する
  - COUNT クエリで総件数を取得し、SELECT クエリでデータを取得する 2 段階のクエリ実行を行う
  - 既存の `toEntity` メソッドを再利用してエンティティ変換を行う
  - `totalPages` を `Math.ceil(totalCount / perPage)` で計算する
  - 既存メソッド (`findAll`, `findBySlug`) への影響がないことを確認する
  - TDD でページネーションクエリ (ソート順、オフセット、リミット、総件数計算、空結果) のテストを先行して作成する
  - _Requirements: 1.1, 2.1, 2.2, 2.3, 2.4_

- [ ] 3. 記事一覧取得ユースケースを実装する
  - ページネーションパラメータを受け取り、クエリリポジトリに委譲して結果を返すユースケースを作成する
  - コンストラクタでクエリリポジトリインターフェースを受け取り、依存性逆転を維持する
  - 将来的なフィルタリングやソート条件の追加に備えた拡張ポイントとして設計する
  - 範囲外のページが指定された場合も空の配列と正確なメタデータを返却する
  - TDD でリポジトリへの委譲と結果の透過的な返却を検証するテストを先行して作成する
  - _Requirements: 1.1, 1.2, 3.4_

- [ ] 4. 記事一覧 API ハンドラを実装して既存ルートグループに統合する
- [ ] 4.1 GET ハンドラのリクエスト処理、バリデーション、レスポンス生成を実装する
  - 既存の `notesApp` ルートグループに GET ハンドラを追加する (既存の POST refresh エンドポイントに影響を与えない)
  - クエリパラメータ (`page`, `per-page`) をパースしてページネーションパラメータ値オブジェクトを生成する
  - バリデーションエラー時は 400 ステータスと RFC 9457 準拠の ProblemDetails をレスポンスする
  - ユースケースを呼び出して記事一覧を取得し、Note エンティティから必要なフィールド (id, title, slug, imageUrl, publishedOn, lastModifiedOn) のみを抽出してレスポンスにマッピングする
  - 日付フィールドは ISO 8601 形式の文字列として返却する
  - レスポンスは `{ notes: [...], pagination: {...} }` の構造で 200 ステータスを返却する
  - データベースエラー時は `console.error` でログ出力し、500 ステータスと ProblemDetails をレスポンスする
  - エラーレスポンスの Content-Type は `application/problem+json` を使用する
  - _Requirements: 1.1, 1.2, 1.3, 1.4, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 6.1, 6.2_

- [ ] 4.2 ハンドラの統合テストを作成する
  - 正常系: ページネーションパラメータあり/なしでの記事一覧取得とレスポンス構造を検証する
  - 異常系: 不正なクエリパラメータでの 400 ProblemDetails レスポンスを検証する
  - 異常系: データベースエラー時の 500 ProblemDetails レスポンスを検証する
  - 既存の `POST /refresh` エンドポイントが引き続き正常動作することを確認する
  - _Requirements: 1.3, 1.4, 3.1, 3.2, 3.3, 3.4, 4.1, 4.2, 4.3, 4.4, 5.1, 5.2, 5.3, 6.1, 6.2, 6.3_
